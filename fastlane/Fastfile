default_platform(:android)

platform :android do

  lane :test do
    # Navigate to project root (..) before executing gradle
    sh("cd .. && gradle test")
  end

  lane :deploy_debug do
    # Navigate to project root (..) before executing gradle
    sh("cd .. && gradle assembleDebug")
  end

  lane :deploy_release do |options|

    # Navigate to project root (..) before executing gradle
    sh(
      "cd .. && gradle assembleRelease " +
      "-Pandroid.injected.signing.store.file=app/release-key.jks " +
      "-Pandroid.injected.signing.store.password='#{ENV['STORE_PASSWORD']}' " +
      "-Pandroid.injected.signing.key.alias='#{ENV['KEY_ALIAS']}' " +
      "-Pandroid.injected.signing.key.password='#{ENV['KEY_PASSWORD']}'"
    )

    set_github_release(
      repository_name: ENV['GITHUB_REPOSITORY'],
      api_token: ENV['GITHUB_TOKEN'],
      name: "Release #{options[:version]}",
      tag_name: options[:version],
      description: "Automated release generated by Fastlane via GitHub Actions.",
      upload_assets: ["app/build/outputs/apk/release/app-release.apk"]
    )
  end
end

name: Android Fastlane CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  create:
    tags:
      - 'v*' # Trigger for releases (currently disabled below)

jobs:
  build_and_release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2'
        bundler-cache: true

    - name: Install Fastlane Plugins
      run: bundle exec fastlane install_plugins

    # ----------------------------------------------------
    # --- RELEASE/SIGNING SETUP (DISABLED BY DEFAULT) ---
    # To enable: Uncomment this block AND the 'Run Fastlane Release' block below.
    # ----------------------------------------------------
    #- name: Decode Keystore
    #  if: ${{ secrets.SIGNING_KEY_STORE_BASE64 != '' }}
    #  env:
    #    ENCODED_STRING: ${{ secrets.SIGNING_KEY_STORE_BASE64 }}
    #  run: |
    #    echo "$ENCODED_STRING" | base64 --decode > app/release-key.jks
    # ----------------------------------------------------

    # --- DEBUG BUILD (Main Branch) ---
    - name: Run Fastlane Debug
      if: github.ref == 'refs/heads/main'
      run: bundle exec fastlane build_debug

    - name: Upload Debug APK
      if: github.ref == 'refs/heads/main'
      uses: actions/upload-artifact@v4
      with:
        name: debug-apk
        path: app/build/outputs/apk/debug/app-debug.apk

    # ----------------------------------------------------
    # --- RELEASE BUILD (TAGS) (DISABLED BY DEFAULT) ---
    # To enable: Uncomment this block AND the 'Decode Keystore' block above.
    # ----------------------------------------------------
    #- name: Run Fastlane Release
    #  if: startsWith(github.ref, 'refs/tags/')
    #  env:
    #    KEYSTORE_FILE: release-key.jks
    #    KEY_ALIAS: ${{ secrets.SIGNING_KEY_ALIAS }}
    #    KEY_PASSWORD: ${{ secrets.SIGNING_KEY_PASSWORD }}
    #    STORE_PASSWORD: ${{ secrets.SIGNING_STORE_PASSWORD }}
    #    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    #  run: bundle exec fastlane release_github version:${{ github.ref_name }}
    # ----------------------------------------------------
